//rukkihuang 2016-12-15  兼容ptt、https版本
//广告
var tgAds=function(obj)
{
	this.info=obj.info;
	this.pics=[];
	this.imgs=[];
	this.btns=[];
	this.now=0;
	this.adBtnBox=null;
	this.box=document.getElementById(obj.box);
	this.autoRun=null;
	this.onBtns=false;
	if(obj.pgv) this.pgv=obj.pgv;
	this.u='//ossweb-img.qq.com/upload/adw/';
	this.ggID=obj.ggID;
	this.ing=true;
	this.mouse=obj.mouse;
	if(obj.noUrl) this.noUrl=true;
	else this.noUrl=false;
	if(obj.alertInfo) this.alertInfo=obj.alertInfo;
	else this.alertInfo=false;
	if(obj.callBack) this.callBack=obj.callBack;
	else this.callBack=function(){};
	//移动端
	this.pUl=null;
	this.dist=0;
	this.xAll=0;
	this.yAll=0;
	if(typeof(obj.auto)=='undefined'||obj.auto) this.auto=true;
	else this.auto=false;
	//客户端？
	this.ua=false;//false是PC true是移动端
	//是否需要切换上一页下一页？目前只满足移动端
	//run
	tgAds.loadjs('//game.qq.com/time/qqadv/Info_new_'+obj.ggID+'.js',this.letsGo,this)
}
tgAds.loadjs=function(url,succ,v)
{
	var elem=document.createElement("script"),lnk="src",tp="text/javascript";
	elem.setAttribute(lnk,url);elem.setAttribute("type",tp);document.body.appendChild(elem);
	if((navigator.userAgent.indexOf('MSIE')==-1)?false:true)
	{
		elem.onreadystatechange=function()
		{
			if(this.readyState&&this.readyState=="loading") return;else succ(v);
		};
	}
	else elem.onload=function(){succ(v);};elem.onerror=function(){};
}
//PC
tgAds.prototype.innerPC=function()
{
	var box1=document.createElement('div');
	box1.className='adPic';
	this.adBtnBox=document.createElement('div');
	this.adBtnBox.className='adBtn';
	for(var i=0;i<this.info.length;i++)
	{
		var gA=document.createElement('a');
		gA.title=decodeURIComponent(this.oDataNew['pos'+this.info[i]][0]);
		if(!this.noUrl){
			if(this.alertInfo) gA.href='javascript:alert("'+this.alertInfo+'")';
			else {
				gA.href=this.oDataNew['pos'+this.info[i]][1];
				if(this.oDataNew['pos'+this.info[i]][1].indexOf('javascript:')<0) gA.target='_blank';
			}
		}
		if(this.pgv){
			if(typeof(setSite)!='undefined'){
				gA.setAttribute('onclick','PTTSendClick(\'adRoll\',\''+this.pgv+(i+1)+'\',\'轮播广告'+(i+1)+'\');');
			}
			else gA.setAttribute('onclick','pgvSendClick({hottag:\''+this.pgv+(i+1)+'\'});');
		}
		i==0?gA.style.left='0':gA.style.left='100%'
		var gP=document.createElement('img');
		if(i<2) gP.src=this.u+this.oDataNew['pos'+this.info[i]][2]
		else
		{
			gP.setAttribute('rel',this.u+this.oDataNew['pos'+this.info[i]][2]);
			var gL=document.createElement('p');
			gL.innerHTML='<span class="loadI">'+decodeURIComponent('%E6%AD%A3%E5%9C%A8%E5%8A%A0%E8%BD%BD%E4%B8%AD%E2%80%A6%E2%80%A6')+'</span>';
			gA.appendChild(gL);
		}
		var gB=document.createElement('a');
		gB.title=decodeURIComponent(this.oDataNew['pos'+this.info[i]][0]);
		gB.href='javascript:void(0)';
		gB.innerText=decodeURIComponent(this.oDataNew['pos'+this.info[i]][0]);
		this.rollFnCtr(gB,i);
		gB.hideFocus="true";
		gA.appendChild(gP);
		box1.appendChild(gA);
		this.adBtnBox.appendChild(gB);
		this.pics.push(gA);
		this.btns.push(gB);
		this.imgs.push(gP);
	}
	this.btns[this.now].className='on';
	this.box.appendChild(box1);
	this.box.appendChild(this.adBtnBox);
	if(i>1){
		var obj=this;
		obj.autoRun=setTimeout(function(){obj.rollFn(obj.now+1);obj.stopFn();},4000)
		obj.box.onmouseover=function(){obj.stopFn();obj.onBtns=true;};
		obj.box.onmouseout=function(){obj.autoRun=setTimeout(function(){obj.rollFn(obj.now+1);obj.stopFn();},4000);obj.onBtns=false};
	}
	else this.adBtnBox.style.display='none';
	this.callBack();
}
tgAds.prototype.rollFn=function(n)
{
	if(this.now==n) return;
	if(n==this.info.length) n=0;
	if(n<0) n=this.info.length-1;
	this.imgs[n].src==''&&(this.imgs[n].src=this.imgs[n].getAttribute('rel'));
	if(n>this.now)
	{
		for(var i=this.now+1; i<n;i++){this.pics[i].style.left='-100%';}
		this.goLeft(this.pics[this.now],this.pics[n],n)
	}
	else
	{
		for(var i=n+1;i<this.now;i++){this.pics[i].style.left='100%';}
		this.goRight(this.pics[this.now],this.pics[n],n)
	}
	for(var i=0;i<this.btns.length;i++){this.btns[i].className='';}
	this.btns[n].className='on';
}
tgAds.prototype.goLeft=function(e1,e2,n)
{
	e1.style.left=0;
	e2.style.left='100%';
	this.ing=false;
	var times=10,obj=this;
	(function(){
		e1.style.left=(times-11)*10+'%';
		e2.style.left=(times-1)*10+'%';
		times--;
		if(times>0) setTimeout(arguments.callee,15)
		else
		{
			obj.now=n;
			if(obj.autoRun===null&&obj.onBtns!=true) obj.autoRun=setTimeout(function(){obj.rollFn(obj.now+1);obj.stopFn();},4000)
			obj.ing=true;
		}
	})()
}
tgAds.prototype.goRight=function(e1,e2,n)
{
	e1.style.left=0;
	e2.style.left='-100%';
	this.ing=false;
	var times=10,obj=this;
	(function(){
		e1.style.left=(11-times)*10+'%';
		e2.style.left=-(times-1)*10+'%';
		times--;
		if(times>0) setTimeout(arguments.callee,15)
		else
		{
			obj.now=n;
			if(obj.autoRun===null&&obj.onBtns!=true) obj.autoRun=setTimeout(function(){obj.rollFn(obj.now+1);obj.stopFn();},4000)
			obj.ing=true;
		}
	})()
}
tgAds.prototype.stopFn=function()
{
	clearTimeout(this.autoRun);
	this.autoRun=null;
}
tgAds.prototype.rollFnCtr=function(e,n)
{
	var obj=this;
	if(obj.mouse)
	{
		e.onmouseover=function()
		{
			if(!obj.ing) return;
			obj.rollFn(n-0);
			obj.stopFn();
		}
	}
	else
	{
		e.onclick=function()
		{
			if(!obj.ing) return;
			obj.rollFn(n-0);
			obj.stopFn();
		}
	}	
}
//移动端
tgAds.prototype.start=function()
{
	if(!event.touches.length){return;}
	this.moveW=0;
	this.x=event.touches[0].pageX;
	this.y=event.touches[0].pageY;
	this.xAll=0;
	this.yAll=0;
	this.stopFnM();
	this.drbr=null;
}
tgAds.prototype.move=function()
{
	if(!event.touches.length){return;}
	this.xAll+=Math.abs(event.touches[0].pageX-this.x);
	this.yAll+=Math.abs(event.touches[0].pageY-this.y);
	if(this.drbr==null){
		if(this.xAll>this.yAll*0.6){
			this.drbr=true;
		}
		else this.drbr=false;
	}
	if(this.drbr){
		event.preventDefault();
		this.moveW=event.touches[0].pageX-this.x;
		this.pUl.style.webkitTransform='translateX('+(this.dist+this.moveW)+'px)';
	}
	else{
		this.moveW=0;
		this.pUl.style.webkitTransform='translateX('+(this.dist+this.moveW)+'px)';
	}
};
tgAds.prototype.end=function()
{
	this.playFnM();
	if(this.drbr) {
		if (this.lastW && this.lastW == this.moveW) return
		else this.lastW = this.moveW;
		if (this.moveW < 0 && this.now < this.info.length - 1) {
			this.now++;
		}
		if (this.moveW > 0) {
			this.now = this.now == 0 ? 0 : this.now - 1
		}
	}
	this.rollFnM(this.now);
};
tgAds.prototype.rollFnM=function(n){
	this.liW=this.pics[0].offsetWidth;
	this.now=n;
	if(this.now>this.info.length-1) this.now=0;
	if(this.now<0) this.now=this.info.length-1;
	if(this.now<this.info.length-1){ var nowP=this.imgs[this.now+1]; if(nowP.src=='') nowP.src= nowP.getAttribute('rel')}
	this.dist=-this.now*this.liW;
	this.pUl.style.webkitTransform='translateX('+this.dist+'px)';
	for(var i=0;i<this.btns.length;i++)
	{
		this.btns[i].className='';
	}
	this.btns[this.now].className='on';
	if(this.auto) this.playFnM();
};
tgAds.prototype.playFnM=function(){
	var _this=this;
	if(_this.auto) if(_this.autoRunM===null) _this.autoRunM=setTimeout(function(){_this.stopFnM();_this.rollFnM(_this.now+1);},4000)
};
tgAds.prototype.stopFnM=function()
{
	var _this=this;
	clearTimeout(_this.autoRunM);
	_this.autoRunM=null;
};
tgAds.prototype.innerI=function()
{
	var box2=document.createElement('div');
	box2.className='adBtn';
	this.pUl=document.createElement('ul')
	this.pUl.style.width=(this.info.length+1)*100+'%';
	this.pUl.className='adPicUl';
	for(var i=0;i<this.info.length;i++)
	{
		var gLi=document.createElement('li');
		var gA=document.createElement('a');
		var gP=document.createElement('img');
		if(i<2) gP.src=this.u+this.oDataNew['pos'+this.info[i]][2];
		else gP.setAttribute('src',this.u+this.oDataNew['pos'+this.info[i]][2]);
		gA.title=decodeURIComponent(this.oDataNew['pos'+this.info[i]][0]);
		if(!this.noUrl){
			gA.setAttribute('href',this.oDataNew['pos'+this.info[i]][1]);
			if(this.oDataNew['pos'+this.info[i]][1].indexOf('javascript:')<0)  gA.setAttribute('target','_blank');
			if(this.pgv) {
				if(typeof(setSite)!='undefined') {
					//gA.setAttribute('onclick','window.open(\''+this.oDataNew['pos'+this.info[i]][1]+'\');PTTSendClick(\'adRoll\',\''+this.pgv+(i+1)+'\',\'轮播广告'+(i+1)+'\');');
					gA.setAttribute('onclick','PTTSendClick(\'adRoll\',\''+this.pgv+(i+1)+'\',\'轮播广告'+(i+1)+'\');');
				}
				//else gA.setAttribute('onclick','window.open(\''+this.oDataNew['pos'+this.info[i]][1]+'\');pgvSendClick({hottag:\''+this.pgv+(i+1)+'\'});');
				else gA.setAttribute('onclick','pgvSendClick({hottag:\''+this.pgv+(i+1)+'\'});');
			}
			//else  gA.setAttribute('onclick','window.open(\''+this.oDataNew['pos'+this.info[i]][1]+'\')');
		}
		gA.appendChild(gP);
		gLi.appendChild(gA);
		gLi.style.width=1/(this.info.length+1)*100+'%';
		this.pUl.appendChild(gLi);
		var gB=document.createElement('a');
		gB.hideFocus="true";
		gB.innerText=decodeURIComponent(this.oDataNew['pos'+this.info[i]][0]);
		box2.appendChild(gB);
		this.pics.push(gA);
		this.btns.push(gB);
		this.imgs.push(gP);
	}
	this.btns[this.now].className='on';
	this.box.appendChild(this.pUl);
	this.box.appendChild(box2);
	var _this=this;
	if(i>1){
		if(_this.auto)_this.autoRunM=setTimeout(function(){_this.stopFnM();_this.rollFnM(_this.now+1);},4000)
		this.pUl.addEventListener("touchstart", function(){_this.start()},false);
		this.pUl.addEventListener("touchmove", function(){_this.move()},false);
		this.pUl.addEventListener("touchend", function(){_this.end()},false);
	}
	else {box2.style.display='none'}
	this.callBack();
};
tgAds.prototype.goBack=function(){
	if(this.ua) this.rollFnM(this.now-1);
	else this.rollFn(this.now-1);
};
tgAds.prototype.goNext=function(){
	if(this.ua) this.rollFnM(this.now+1);
	else  this.rollFn(this.now+1);
};
//run
tgAds.prototype.letsGo=function(obj)
{
	//var obj=this;
	obj.oDataNew=window['oDaTaNew'+obj.ggID];
	if(typeof(obj.info)=='string')
	{
		obj.info2=[];
		for(var o in obj.oDataNew)
		{
			if(obj.oDataNew[o][5]==obj.info) 
			{
				var o2={};
				o2.num=obj.oDataNew[o][6];
				o2.name=o;
				obj.info2.push(o2);
			}
		}
		obj.info2.sort(function(a,b) { return a.num - b.num;})
		obj.info=[];
		for(var i=0;i<obj.info2.length;i++)
		{
			obj.info.push(obj.info2[i].name.replace(new RegExp('pos'),""))
		}
	}
	//PC端
	if(navigator.userAgent.toLowerCase().indexOf("ipad")<0&&navigator.userAgent.toLowerCase().indexOf("iphone")<0&&navigator.userAgent.toLowerCase().indexOf("android")<0)
	{
		obj.ua=false;
		obj.innerPC();
	}	
	//移动端
	else
	{
		obj.ua=true;
		obj.innerI();
	}
}
//设置单帧广告的dom
//单帧广告
tgAds.SingleAds={};//存放所有的单帧广告数据
tgAds.process=function(gAds,id,ggID){
	var ad=false;
	if(gAds['pos'+id]) ad=gAds['pos'+id];
	// else if(gAds.common[id]) ad=gAds.common[id];
	else console.log('没拉到广告位（ID:“'+id+'”），请确认广告位ID正确，或广告已下架');
	if(ad!=false) ad={adUrl:ad[1],imgUrl:'//ossweb-img.qq.com/upload/adw/'+ad[2],Fname:decodeURIComponent(ad[0]),time:ad[9]+' '+ad[10]};
	// if(ad!=false) ad={adUrl:ad[1],imgUrl:'//ossweb-img.qq.com/upload/adw/'+ad[2],Fname:decodeURIComponent(ad[0]),id:id,adId:ad.adId,ecode:ad.ecode,ggID:ggID};
	return ad;
};
//设置所有单帧广告的数据
tgAds.setSingleInfo=function(elem,ggInfo){
	if(typeof(tgAds.SingleAds[ggInfo[0]])=='undefined'){
		tgAds.SingleAds[ggInfo[0]]={};//ggInfo[0];
		tgAds.SingleAds[ggInfo[0]].pindao=ggInfo[0];
		tgAds.SingleAds[ggInfo[0]].infos=[];
		//tgAds.SingleAds[ggInfo[0]].stat=false;//还未插入广告
	}
	//若单帧还未创建和插入
	if(!elem.getAttribute('data-stat')){
		tgAds.SingleAds[ggInfo[0]].infos.push({
			elem:elem,
			id:ggInfo[1],
			stat:false//还未插入广告
		});
		elem.setAttribute('data-stat',false)
	}
	//输出的数据结构：此频道下的所有单帧广告都插入到同一个频道ID的infos里
	//tgAds.SingleAds={
	//	'频道ID':{
	//		pindao:'频道ID',
	//		infos:[
	//			{elem:a,id:'广告位ID',stat:true},
	//			{elem:a,id:'广告位ID',stat:true},
	//			...
	//		]
	//	},
	//	....
	//};
};
tgAds.setSingleDom=function(adend,obj){
	if(!obj.stat){
		var img=new Image();
		img.src=adend.imgUrl;
		obj.elem.innerHTML='';
		obj.elem.appendChild(img);
		obj.elem.href=adend.adUrl==''?'javascript:void(0)':adend.adUrl;
		obj.elem.setAttribute('title',adend.Fname);
		img.setAttribute('alt',adend.Fname);
		// tgAds.eas(adend,1);
		// tgAds.setSingleClick(obj.elem,adend);
		obj.stat=true;//已经插入了广告数据
		obj.elem.setAttribute('data-stat',true)
		if(obj.elem.getAttribute('data-dom')){
			var dataDom=document.createElement(obj.elem.getAttribute('data-dom'));
			dataDom.innerText=adend.Fname;
			obj.elem.appendChild(dataDom)
		}
		if(obj.elem.getAttribute('data-time')!==null){
			obj.elem.setAttribute('data-time',adend.time)
		}
	}
};
tgAds.run=function(){
	var elems=document.getElementsByTagName('a');
	for(var i=0;i<elems.length;i++){
		if(elems[i].getAttribute('data-tgadieg')||elems[i].getAttribute('data-TGAD')){
			var tagN=elems[i].getAttribute('data-tgadieg')?elems[i].getAttribute('data-tgadieg'):elems[i].getAttribute('data-TGAD');
			var ggInfo=tagN.split(',');
			tgAds.setSingleInfo(elems[i],ggInfo);
		}
	}
	for(var o in tgAds.SingleAds){
		//如果没有load过这个广告数据
		if(typeof(window['oDaTaNew'+tgAds.SingleAds[o].pindao])=='undefined'){
			tgAds.loadjs('//game.qq.com/time/qqadv/Info_new_'+tgAds.SingleAds[o].pindao+'.js',function(obj){
				var allData=window['oDaTaNew'+obj.pindao];
				for(var i=0;i<obj.infos.length;i++){
					var adend=tgAds.process(allData,obj.infos[i].id,obj.pindao);
					if(typeof(adend)!='boolean'){
						tgAds.setSingleDom(adend,obj.infos[i]);
					}
					else{
						obj.infos[i].elem.innerText='广告位ID:'+obj.infos[i].id+'没有拉到,请确认广告位ID正确，或广告已下架'
					}
				};
			},tgAds.SingleAds[o]);
		}
		//如果已经有这个频道idata的数据了
		else{
			var obj=tgAds.SingleAds[o],allData=window['oDaTaNew'+obj.pindao];
			for(var i=0;i<obj.infos.length;i++){
				if(!obj.infos[i].stat){
					var adend=tgAds.process(allData,obj.infos[i].id,obj.pindao);
					if(typeof(adend)!='boolean'){
						tgAds.setSingleDom(adend,obj.infos[i]);
					}
					else{
						obj.infos[i].elem.innerText='广告位ID:'+obj.infos[i].id+'没有拉到,请确认广告位ID正确，或广告已下架'
					}
				}
			};
		}
	}
};
tgAds.run();
if(typeof (iData_New_Tplparser)=='undefined'){
	var iData_New_Tplparser=new Object();
	iData_New_Tplparser.run=tgAds.run;
}

//调用
//var test=new tgAds({
//	ggID:'461'//填写轮播广告所属的频道ID("频道管理"-"频道ID")
//	,info:['2024','2025','2026','2027','2033','2034']//,info:'201206'
//	//info的值可以有2种形式：1.直接填写需要的这几帧的广告位ID("广告位管理"-"广告位ID") |或者| 2.填写广告位所属组ID("广告位管理"-"广告位所属组ID"),然后会自动拉取此组下所有帧广告，然后按照广告位排序来输入1234..帧。
//	,box:'ggBox'//填写放置广告的div的ID
//	,pgv:'index.adsRolling.ad' // ,pgv:'mainAd'
// [可选参数]pgv接受2种形式（普通点击流orPPT点击流）：普通点击流'index.adsRolling.ad'点击流名称，序号会自动加，eg第一帧叫:'index.adsRolling.ad1' |||||| PTT点击流'mainAd'：点击流名称，序号会自动加，eg第一帧叫:PTTSendClick('adRoll','mainAd1','轮播广告1')
//	//,auto:true//[可选参数]移动端禁止自动滚动，不添加此项或者true为定时自动滚动
//	//,mouse:false//[可选参数,若点击触发请删掉此项]，true为鼠标经过小按钮触发翻页。false为点击小按钮触发翻页（默认为点击触发）最好是点击触发，不然晃得眼花
//	//,noUrl:true//[可选参数]如果纯展示不能点击跳转请用这个参数
// //,alertInfo:'敬请期待'//[可选参数]如果纯展示不跳转，但是需要有弹出提示，则可使用
//});
//
//document.getElementById('back').onclick=function(){
//	test.goBack();
//}
//document.getElementById('next').onclick=function(){
//	test.goNext();
//}/*  |xGv00|4f5440960999fa41bc27fcb4f235b44f */